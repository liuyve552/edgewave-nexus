<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Baseline DApp (Slow)</title>
    <style>
      :root {
        color-scheme: dark;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji",
          "Segoe UI Emoji";
        background: #05070f;
        color: #e5e7eb;
      }
      .wrap {
        padding: 16px;
      }
      .card {
        border: 1px solid rgba(148, 163, 184, 0.18);
        border-radius: 14px;
        background: rgba(2, 6, 23, 0.65);
        padding: 14px;
      }
      .row {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      .muted {
        color: rgba(226, 232, 240, 0.7);
        font-size: 12px;
      }
      .mono {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      }
      button {
        background: rgba(148, 163, 184, 0.12);
        color: #e5e7eb;
        border: 1px solid rgba(148, 163, 184, 0.18);
        border-radius: 10px;
        padding: 8px 10px;
        cursor: pointer;
      }
      button:hover {
        background: rgba(148, 163, 184, 0.18);
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <div class="row" style="justify-content: space-between">
          <div>
            <div style="font-weight: 600">Baseline DApp</div>
            <div class="muted">Single RPC + intentional delay</div>
          </div>
          <div class="row">
            <button id="btnBlock">Measure Block</button>
            <button id="btnReceipt">Measure Receipt</button>
          </div>
        </div>

        <div style="height: 10px"></div>

        <div class="row">
          <div class="muted">RPC</div>
          <div id="rpc" class="mono" style="max-width: 520px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap"></div>
        </div>
        <div style="height: 8px"></div>
        <div class="row">
          <div class="muted">FCP</div>
          <div id="fcp" class="mono">—</div>
          <div class="muted">API</div>
          <div id="api" class="mono">—</div>
          <div class="muted">Block</div>
          <div id="block" class="mono">—</div>
          <div class="muted">Receipt</div>
          <div id="receipt" class="mono">—</div>
        </div>
      </div>
    </div>

    <script>
      // NOTE: This file is intentionally framework-free so it can be deployed as static assets on ESA Pages.
      const qs = new URLSearchParams(location.search);
      const rpcUrls = (qs.get("rpcUrls") || "").split(",").map((s) => s.trim()).filter(Boolean);
      const rpcUrl = rpcUrls[0] || "https://cloudflare-eth.com";
      const delayMs = Number(qs.get("delayMs") || "0") || 0;

      const state = {
        fcpMs: undefined,
        apiLatencyMs: undefined,
        fastest: rpcUrl,
        blockNumber: undefined,
        receiptLookupMs: undefined,
        status: "idle",
      };

      const elRpc = document.getElementById("rpc");
      const elFcp = document.getElementById("fcp");
      const elApi = document.getElementById("api");
      const elBlock = document.getElementById("block");
      const elReceipt = document.getElementById("receipt");

      elRpc.textContent = rpcUrl;

      function postMetrics() {
        parent.postMessage(
          {
            type: "edgewave-metrics",
            side: "baseline",
            payload: { ...state },
          },
          location.origin,
        );
      }

      function render() {
        elFcp.textContent = state.fcpMs ? `${state.fcpMs.toFixed(0)} ms` : "—";
        elApi.textContent = state.apiLatencyMs ? `${state.apiLatencyMs.toFixed(0)} ms` : "—";
        elBlock.textContent = state.blockNumber != null ? String(state.blockNumber) : "—";
        elReceipt.textContent = state.receiptLookupMs ? `${state.receiptLookupMs.toFixed(0)} ms` : "—";
      }

      try {
        const obs = new PerformanceObserver((list) => {
          for (const e of list.getEntries()) {
            if (e.name === "first-contentful-paint") {
              state.fcpMs = e.startTime;
              render();
              postMetrics();
            }
          }
        });
        obs.observe({ type: "paint", buffered: true });
      } catch {}

      async function rpcCall(method, params) {
        const res = await fetch(rpcUrl, {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ jsonrpc: "2.0", id: 1, method, params }),
        });
        const json = await res.json();
        if (!res.ok || json.error) throw new Error("RPC failed");
        return json.result;
      }

      function hexToNumber(hex) {
        try {
          return Number(BigInt(hex));
        } catch {
          return undefined;
        }
      }

      async function measureBlock() {
        state.status = "loading";
        state.apiLatencyMs = undefined;
        render();
        postMetrics();
        const t0 = performance.now();
        await new Promise((r) => setTimeout(r, delayMs));
        const hex = await rpcCall("eth_blockNumber", []);
        const t1 = performance.now();
        state.apiLatencyMs = t1 - t0;
        state.blockNumber = hexToNumber(hex);
        state.fastest = rpcUrl;
        state.status = "ok";
        render();
        postMetrics();
      }

      async function measureReceipt() {
        state.status = "loading";
        state.receiptLookupMs = undefined;
        render();
        postMetrics();
        const knownMainnetTx = "0x7f3d0a6f8b3a9d66d5d64d1ef2b35b8aab2e1b9f7469b1b0b44e1afc4c4c7f0f";
        const t0 = performance.now();
        await new Promise((r) => setTimeout(r, delayMs));
        await rpcCall("eth_getTransactionReceipt", [knownMainnetTx]);
        const t1 = performance.now();
        state.receiptLookupMs = t1 - t0;
        state.status = "ok";
        render();
        postMetrics();
      }

      async function safe(fn) {
        try {
          await fn();
        } catch (e) {
          console.log("baseline-dapp error", e);
          state.status = "error";
          render();
          postMetrics();
        }
      }

      document.getElementById("btnBlock").addEventListener("click", () => void safe(measureBlock));
      document.getElementById("btnReceipt").addEventListener("click", () => void safe(measureReceipt));

      window.addEventListener("message", (evt) => {
        if (evt.origin !== location.origin) return;
        if (evt.data && evt.data.type === "measure") {
          if (evt.data.what === "receipt") void safe(measureReceipt);
          else void safe(measureBlock);
        }
      });

      // Initial measure
      void safe(measureBlock);
    </script>
  </body>
</html>

